generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ===================== ENUMS =====================

enum StaffRole {
  ADMIN      @map("admin")
  INSTRUCTOR @map("instructor")

  @@map("staff_role")
}

enum OrderStatus {
  PENDING            @map("pending")
  PAID               @map("paid")
  PAYMENT_FAILED     @map("payment_failed")
  VOID               @map("void")
  REFUNDED           @map("refunded")
  PARTIALLY_REFUNDED @map("partially_refunded")

  @@map("order_status")
}

enum OrderType {
  CHECKOUT     @map("checkout")
  SUBSCRIPTION @map("subscription")

  @@map("order_type")
}

enum ProductContentType {
  COURSE           @map("course")
  MASTER_CLASS     @map("master_class")
  BUNDLE           @map("bundle")
  DIGITAL_DOWNLOAD @map("digital_download")

  @@map("product_content_type")
}

enum SubscriptionStatus {
  TRIALING @map("trialing")
  ACTIVE   @map("active")
  PAST_DUE @map("past_due")
  CANCELED @map("canceled")
  PAUSED   @map("paused")

  @@map("subscription_status")
}

enum PurchaseStatus {
  ACTIVE  @map("active")
  REVOKED @map("revoked")
  EXPIRED @map("expired")

  @@map("purchase_status")
}

enum CouponValidityType {
  LIFETIME @map("lifetime")
  DURATION @map("duration")
  ONE_TIME @map("one_time")

  @@map("coupon_validity_type")
}

enum CouponDiscountType {
  PERCENTAGE   @map("percentage")
  FIXED_AMOUNT @map("fixed_amount")
  FREE_TRIAL   @map("free_trial")

  @@map("coupon_discount_type")
}

enum LessonType {
  VIDEO @map("video")
  TEXT  @map("text")

  @@map("lesson_type")
}

enum TopicType {
  VIDEO @map("video")
  TEXT  @map("text")

  @@map("topic_type")
}

enum BunnyLibraryType {
  PUBLIC  @map("public")
  PRIVATE @map("private")

  @@map("bunny_library_type")
}

enum VideoStatus {
  PROCESSING @map("processing")
  READY      @map("ready")
  FAILED     @map("failed")

  @@map("video_status")
}

enum QuestionType {
  SINGLE   @map("single")
  MULTIPLE @map("multiple")

  @@map("question_type")
}

// ===================== Staff (Admin/Instructor) =====================

model Staff {
  id           String    @id @default(dbgenerated("uuidv7()")) @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  firstName    String?   @map("first_name") @db.VarChar(100)
  lastName     String?   @map("last_name") @db.VarChar(100)
  role         StaffRole @default(INSTRUCTOR)
  isActive     Boolean   @default(true) @map("is_active")
  bio          String?   @db.Text
  avatarUrl    String?   @map("avatar_url") @db.VarChar(500)
  metadata     Json?     @default("{}")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  staffSessions            StaffSession[]
  createdProducts          Product[]              @relation("ProductCreatedBy")
  instructorProducts       Product[]              @relation("ProductInstructor")
  createdSubscriptionPlans SubscriptionPlan[]
  bundleItemsAdded         BundleItem[]
  planProductsAdded        SubscriptionPlanProduct[]
  scheduledSessions        MasterClassSession[]   @relation("SessionScheduledBy")
  updatedSessions          MasterClassSession[]   @relation("SessionUpdatedBy")
  posts                    Post[]
  videos                   Video[]

  @@index([email], map: "idx_staff_email")
  @@map("staff")
}

model StaffSession {
  id        String    @id @default(dbgenerated("uuidv7()")) @db.Uuid
  staffId   String    @map("staff_id") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  revokedAt DateTime? @map("revoked_at") @db.Timestamptz(6)
  staff     Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([staffId], map: "staff_sessions_staff_id_index")
  @@map("staff_sessions")
}

// ===================== Customer Auth =====================

model Customer {
  id                    String              @id @default(dbgenerated("uuidv7()")) @db.Uuid
  surecartId            String?             @unique @map("surecart_id") @db.VarChar(100)
  email                 String              @unique @db.VarChar(255)
  passwordHash          String?             @map("password_hash") @db.VarChar(255)
  firstName             String?             @map("first_name") @db.VarChar(100)
  lastName              String?             @map("last_name") @db.VarChar(100)
  userNicename          String?             @map("user_nicename") @db.VarChar(100)
  phone                 String?             @db.VarChar(50)
  taxIdentifier         String?             @map("tax_identifier") @db.VarChar(100)
  taxIdentifierType     String?             @map("tax_identifier_type") @db.VarChar(50)
  stripeCustomerId      String?             @map("stripe_customer_id") @db.VarChar(255)
  requiresPasswordReset Boolean             @default(false) @map("requires_password_reset")
  totalOrders           Int                 @default(0) @map("total_orders")
  totalSpentCents       BigInt              @default(0) @map("total_spent_cents")
  activeSubscriptions   Int                 @default(0) @map("active_subscriptions")
  metadata              Json?               @default("{}")
  isLiveMode            Boolean             @default(true) @map("is_live_mode")
  createdAt             DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime            @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt             DateTime?           @map("deleted_at") @db.Timestamptz(6)
  languagePreference    String              @default("en") @map("language_preference") @db.VarChar(10)
  age                   Int?                @db.SmallInt
  grade                 String?             @db.VarChar(20)
  subjects              Json                @default("[]")
  learningGoals         Json                @default("[]") @map("learning_goals")
  onboardingCompleted   Boolean             @default(false) @map("onboarding_completed")

  // Relations
  oauthAccounts        OAuthAccount[]
  sessions             Session[]
  addresses            CustomerAddress[]
  subscriptions        Subscription[]
  orders               Order[]
  purchases            Purchase[]
  masterClassAttendees MasterClassAttendee[]

  @@index([email], map: "idx_customers_email")
  @@map("customers")
}

model OAuthAccount {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId        String   @map("customer_id") @db.Uuid
  provider          String   @db.VarChar(50)
  providerAccountId String   @map("provider_account_id") @db.VarChar(255)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([provider, providerAccountId], map: "oauth_accounts_provider_unique")
  @@index([provider, providerAccountId], map: "oauth_accounts_provider_provider_account_id_index")
  @@index([customerId], map: "oauth_accounts_customer_id_index")
  @@map("oauth_accounts")
}

model Session {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId String    @map("customer_id") @db.Uuid
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  revokedAt  DateTime? @map("revoked_at") @db.Timestamptz(6)
  customer   Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([customerId], map: "sessions_customer_id_index")
  @@map("sessions")
}

model CustomerAddress {
  id          String   @id @default(dbgenerated("uuidv7()")) @db.Uuid
  customerId  String   @map("customer_id") @db.Uuid
  addressType String   @map("address_type") @db.VarChar(20)
  line1       String?  @map("line_1") @db.VarChar(255)
  line2       String?  @map("line_2") @db.VarChar(255)
  city        String?  @db.VarChar(100)
  state       String?  @db.VarChar(100)
  postalCode  String?  @map("postal_code") @db.VarChar(20)
  country     String?  @db.VarChar(2)
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([customerId], map: "idx_addresses_customer")
  @@map("customer_addresses")
}

// ===================== Coupons =====================

model Coupon {
  id                     String             @id @default(dbgenerated("uuidv7()")) @db.Uuid
  surecartId             String?            @unique @map("surecart_id") @db.VarChar(100)
  surecartPromotionId    String?            @map("surecart_promotion_id") @db.VarChar(100)
  code                   String             @unique @db.VarChar(100)
  name                   String             @db.VarChar(255)
  description            String?            @db.Text
  discountType           CouponDiscountType @map("discount_type")
  discountValue          BigInt             @map("discount_value")
  currency               String?            @default("usd") @db.VarChar(3)
  validityType           CouponValidityType @map("validity_type")
  durationMonths         Int?               @map("duration_months")
  maxRedemptions         Int?               @map("max_redemptions")
  currentRedemptions     Int                @default(0) @map("current_redemptions")
  maxPerCustomer         Int?               @default(1) @map("max_per_customer")
  appliesTo              String?            @default("any") @map("applies_to") @db.VarChar(20)
  minPurchaseAmountCents BigInt?            @map("min_purchase_amount_cents")
  validFrom              DateTime?          @map("valid_from") @db.Timestamptz(6)
  validUntil             DateTime?          @map("valid_until") @db.Timestamptz(6)
  isActive               Boolean            @default(true) @map("is_active")
  isArchived             Boolean            @default(false) @map("is_archived")
  isNewCustomerOnly      Boolean            @default(false) @map("is_new_customer_only")
  metadata               Json?              @default("{}")
  createdAt              DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime           @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  productRestrictions CouponProductRestriction[]
  orders              Order[]
  orderItems          OrderItem[]
  subscriptions       Subscription[]

  @@map("coupons")
}

model CouponProductRestriction {
  id        String   @id @default(dbgenerated("uuidv7()")) @db.Uuid
  couponId  String   @map("coupon_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([couponId, productId])
  @@index([couponId], map: "idx_coupon_restrictions_coupon")
  @@index([productId], map: "idx_coupon_restrictions_product")
  @@map("coupon_product_restrictions")
}

// ===================== Products =====================

model Product {
  id                       String              @id @default(dbgenerated("uuidv7()")) @db.Uuid
  surecartPriceId          String?             @unique @map("surecart_price_id") @db.VarChar(100)
  surecartProductId        String?             @map("surecart_product_id") @db.VarChar(100)
  productName              String              @map("product_name") @db.VarChar(255)
  productSlug              String?             @map("product_slug") @db.VarChar(255)
  productDescription       String?             @map("product_description") @db.Text
  amountCents              BigInt              @default(0) @map("amount_cents")
  currency                 String              @default("usd") @db.VarChar(3)
  isRecurring              Boolean             @default(false) @map("is_recurring")
  recurringInterval        String?             @map("recurring_interval") @db.VarChar(20)
  recurringIntervalCount   Int                 @default(1) @map("recurring_interval_count")
  trialDays                Int                 @default(0) @map("trial_days")
  setupFeeEnabled          Boolean             @default(false) @map("setup_fee_enabled")
  setupFeeCents            BigInt              @default(0) @map("setup_fee_cents")
  setupFeeName             String?             @map("setup_fee_name") @db.VarChar(255)
  taxCategory              String?             @map("tax_category") @db.VarChar(50)
  taxEnabled               Boolean             @default(true) @map("tax_enabled")
  allowOutOfStockPurchases Boolean             @default(false) @map("allow_out_of_stock_purchases")
  autoFulfill              Boolean             @default(true) @map("auto_fulfill")
  revokeAfterDays          Int?                @map("revoke_after_days")
  purchaseLimit            Int?                @map("purchase_limit")
  trackInventory           Boolean             @default(false) @map("track_inventory")
  stockQuantity            Int?                @map("stock_quantity")
  allowOutOfStock          Boolean             @default(false) @map("allow_out_of_stock")
  requiresShipping         Boolean             @default(false) @map("requires_shipping")
  isActive                 Boolean             @default(true) @map("is_active")
  isArchived               Boolean             @default(false) @map("is_archived")
  contentType              ProductContentType  @default(COURSE) @map("content_type")
  maxAttendees             Int?                @map("max_attendees")
  currentAttendees         Int                 @default(0) @map("current_attendees")
  thumbnailUrl             String?             @map("thumbnail_url") @db.VarChar(1000)
  stripeProductId          String?             @map("stripe_product_id") @db.VarChar(255)
  stripePriceId            String?             @map("stripe_price_id") @db.VarChar(255)
  isPublished              Boolean             @default(false) @map("is_published")
  publishedAt              DateTime?           @map("published_at") @db.Timestamptz(6)
  sortOrder                Int                 @default(0) @map("sort_order")
  createdByStaffId         String?             @map("created_by_staff_id") @db.Uuid
  instructorId             String?             @map("instructor_id") @db.Uuid
  wpPostId                 Int?                @map("wp_post_id")
  metadata                 Json?               @default("{}")
  createdAt                DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime            @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt                DateTime?           @map("deleted_at") @db.Timestamptz(6)

  // Relations
  createdByStaff      Staff?                    @relation("ProductCreatedBy", fields: [createdByStaffId], references: [id], onUpdate: NoAction)
  instructor          Staff?                    @relation("ProductInstructor", fields: [instructorId], references: [id], onUpdate: NoAction)
  couponRestrictions  CouponProductRestriction[]
  bundleAsParent      BundleItem[]              @relation("BundleParent")
  bundleAsItem        BundleItem[]              @relation("BundleChild")
  planProducts        SubscriptionPlanProduct[]
  orderItems          OrderItem[]
  purchases           Purchase[]
  masterClassSessions MasterClassSession[]
  legacySubscriptions Subscription[]            @relation("LegacyProduct")
  sections            Section[]
  lessons             Lesson[]
  topics              Topic[]
  quizzes             Quiz[]

  @@index([surecartPriceId], map: "idx_products_surecart_price")
  @@index([productSlug], map: "idx_products_slug")
  @@index([instructorId], map: "idx_products_instructor")
  @@index([wpPostId], map: "idx_products_wp_post_id")
  @@map("products")
}

// ===================== Bundles =====================

model BundleItem {
  id              String   @id @default(dbgenerated("uuidv7()")) @db.Uuid
  bundleProductId String   @map("bundle_product_id") @db.Uuid
  itemProductId   String   @map("item_product_id") @db.Uuid
  quantity        Int      @default(1)
  addedByStaffId  String?  @map("added_by_staff_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  bundleProduct   Product  @relation("BundleParent", fields: [bundleProductId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  itemProduct     Product  @relation("BundleChild", fields: [itemProductId], references: [id], onUpdate: NoAction)
  addedByStaff    Staff?   @relation(fields: [addedByStaffId], references: [id], onUpdate: NoAction)

  @@unique([bundleProductId, itemProductId])
  @@index([bundleProductId], map: "idx_bundle_items_bundle")
  @@index([itemProductId], map: "idx_bundle_items_item")
  @@map("bundle_items")
}

// ===================== Subscription Plans =====================

model SubscriptionPlan {
  id                     String                   @id @default(dbgenerated("uuidv7()")) @db.Uuid
  name                   String                   @db.VarChar(255)
  slug                   String?                  @unique @db.VarChar(255)
  description            String?                  @db.Text
  amountCents            BigInt                   @map("amount_cents")
  currency               String                   @default("usd") @db.VarChar(3)
  recurringInterval      String                   @map("recurring_interval") @db.VarChar(20)
  recurringIntervalCount Int                      @default(1) @map("recurring_interval_count")
  trialDays              Int                      @default(0) @map("trial_days")
  isActive               Boolean                  @default(true) @map("is_active")
  isArchived             Boolean                  @default(false) @map("is_archived")
  createdByStaffId       String?                  @map("created_by_staff_id") @db.Uuid
  stripeProductId        String?                  @map("stripe_product_id") @db.VarChar(255)
  stripePriceId          String?                  @map("stripe_price_id") @db.VarChar(255)
  metadata               Json?                    @default("{}")
  createdAt              DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime                 @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  createdByStaff Staff?                   @relation(fields: [createdByStaffId], references: [id], onUpdate: NoAction)
  planProducts   SubscriptionPlanProduct[]
  subscriptions  Subscription[]
  posts          Post[]

  @@index([slug], map: "idx_subscription_plans_slug")
  @@map("subscription_plans")
}

model SubscriptionPlanProduct {
  id             String           @id @default(dbgenerated("uuidv7()")) @db.Uuid
  planId         String           @map("plan_id") @db.Uuid
  productId      String           @map("product_id") @db.Uuid
  addedByStaffId String?          @map("added_by_staff_id") @db.Uuid
  createdAt      DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  plan           SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product        Product          @relation(fields: [productId], references: [id], onUpdate: NoAction)
  addedByStaff   Staff?           @relation(fields: [addedByStaffId], references: [id], onUpdate: NoAction)

  @@unique([planId, productId])
  @@index([planId], map: "idx_plan_products_plan")
  @@index([productId], map: "idx_plan_products_product")
  @@map("subscription_plan_products")
}

// ===================== Subscriptions =====================

model Subscription {
  id                     String             @id @default(dbgenerated("uuidv7()")) @db.Uuid
  surecartId             String?            @unique @map("surecart_id") @db.VarChar(100)
  couponId               String?            @map("coupon_id") @db.Uuid
  customerId             String             @map("customer_id") @db.Uuid
  planId                 String?            @map("plan_id") @db.Uuid
  legacyProductId        String?            @map("legacy_product_id") @db.Uuid
  status                 SubscriptionStatus @default(ACTIVE)
  currency               String             @default("usd") @db.VarChar(3)
  unitAmountCents        BigInt             @map("unit_amount_cents")
  recurringInterval      String             @map("recurring_interval") @db.VarChar(20)
  recurringIntervalCount Int                @default(1) @map("recurring_interval_count")
  quantity               Int                @default(1)
  trialStart             DateTime?          @map("trial_start") @db.Timestamptz(6)
  trialEnd               DateTime?          @map("trial_end") @db.Timestamptz(6)
  currentPeriodStart     DateTime           @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd       DateTime           @map("current_period_end") @db.Timestamptz(6)
  cancelAtPeriodEnd      Boolean            @default(false) @map("cancel_at_period_end")
  canceledAt             DateTime?          @map("canceled_at") @db.Timestamptz(6)
  endedAt                DateTime?          @map("ended_at") @db.Timestamptz(6)
  stripeSubscriptionId   String?            @map("stripe_subscription_id") @db.VarChar(255)
  metadata               Json?              @default("{}")
  isLiveMode             Boolean            @default(true) @map("is_live_mode")
  createdAt              DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime           @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  coupon        Coupon?           @relation(fields: [couponId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  customer      Customer          @relation(fields: [customerId], references: [id], onUpdate: NoAction)
  plan          SubscriptionPlan? @relation(fields: [planId], references: [id], onUpdate: NoAction)
  legacyProduct Product?          @relation("LegacyProduct", fields: [legacyProductId], references: [id], onUpdate: NoAction)
  orderItems    OrderItem[]
  purchases     Purchase[]

  @@index([customerId], map: "idx_subscriptions_customer")
  @@index([planId], map: "idx_subscriptions_plan")
  @@map("subscriptions")
}

// ===================== Orders (Partitioned by year) =====================

model Order {
  id                      String      @default(dbgenerated("uuidv7()")) @db.Uuid
  surecartId              String?     @map("surecart_id") @db.VarChar(100)
  orderNumber             String      @map("order_number") @db.VarChar(50)
  status                  OrderStatus @default(PENDING)
  orderType               OrderType   @default(CHECKOUT) @map("order_type")
  customerId              String      @map("customer_id") @db.Uuid
  couponId                String?     @map("coupon_id") @db.Uuid
  currency                String      @default("usd") @db.VarChar(3)
  subtotalCents           BigInt      @default(0) @map("subtotal_cents")
  discountCents           BigInt      @default(0) @map("discount_cents")
  taxCents                BigInt      @default(0) @map("tax_cents")
  shippingCents           BigInt      @default(0) @map("shipping_cents")
  totalCents              BigInt      @default(0) @map("total_cents")
  amountDueCents          BigInt      @default(0) @map("amount_due_cents")
  trialCents              BigInt?     @default(0) @map("trial_cents")
  prorationCents          BigInt?     @default(0) @map("proration_cents")
  billingAddressSnapshot  Json?       @map("billing_address_snapshot")
  shippingAddressSnapshot Json?       @map("shipping_address_snapshot")
  taxIdentifier           String?     @map("tax_identifier") @db.VarChar(100)
  taxIdentifierType       String?     @map("tax_identifier_type") @db.VarChar(50)
  paymentMethod           String?     @map("payment_method") @db.VarChar(50)
  paymentFailureReason    String?     @map("payment_failure_reason") @db.Text
  stripePaymentIntentId   String?     @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeInvoiceId         String?     @map("stripe_invoice_id") @db.VarChar(255)
  refundAmountCents       BigInt?     @default(0) @map("refund_amount_cents")
  refundReason            String?     @map("refund_reason") @db.Text
  refundedAt              DateTime?   @map("refunded_at") @db.Timestamptz(6)
  trackingNumbers         String[]    @map("tracking_numbers")
  invoiceUrl              String?     @map("invoice_url") @db.VarChar(500)
  metadata                Json?       @default("{}")
  isLiveMode              Boolean     @default(true) @map("is_live_mode")
  createdAt               DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime?   @default(now()) @map("updated_at") @db.Timestamptz(6)
  paidAt                  DateTime?   @map("paid_at") @db.Timestamptz(6)
  createdYear             Int         @default(dbgenerated()) @map("created_year")

  // Relations
  customer   Customer    @relation(fields: [customerId], references: [id], onUpdate: NoAction)
  coupon     Coupon?     @relation(fields: [couponId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  orderItems OrderItem[]

  @@id([id, createdYear])
  @@index([customerId], map: "idx_orders_customer")
  @@index([orderNumber], map: "idx_orders_number")
  @@index([status], map: "idx_orders_status")
  @@map("orders")
}

model OrderItem {
  id                String        @default(dbgenerated("uuidv7()")) @db.Uuid
  orderId           String        @map("order_id") @db.Uuid
  orderYear         Int           @default(dbgenerated()) @map("order_year")
  couponId          String?       @map("coupon_id") @db.Uuid
  productId         String        @map("product_id") @db.Uuid
  quantity          Int           @default(1)
  unitAmountCents   BigInt        @map("unit_amount_cents")
  discountCents     BigInt        @default(0) @map("discount_cents")
  taxCents          BigInt        @default(0) @map("tax_cents")
  totalCents        BigInt        @map("total_cents")
  currency          String        @default("usd") @db.VarChar(3)
  subscriptionId    String?       @map("subscription_id") @db.Uuid
  refundStatus      String?       @map("refund_status") @db.VarChar(20)
  refundAmountCents BigInt?       @default(0) @map("refund_amount_cents")
  refundedAt        DateTime?     @map("refunded_at") @db.Timestamptz(6)
  createdAt         DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime?     @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  order        Order         @relation(fields: [orderId, orderYear], references: [id, createdYear], onDelete: Cascade, onUpdate: NoAction)
  coupon       Coupon?       @relation(fields: [couponId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  product      Product       @relation(fields: [productId], references: [id], onUpdate: NoAction)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@id([id, orderYear])
  @@index([orderId], map: "idx_order_items_order")
  @@index([productId], map: "idx_order_items_product")
  @@map("order_items")
}

// ===================== Purchases (Access Entitlements) =====================

model Purchase {
  id              String         @id @default(dbgenerated("uuidv7()")) @db.Uuid
  surecartId      String?        @unique @map("surecart_id") @db.VarChar(100)
  customerId      String         @map("customer_id") @db.Uuid
  productId       String         @map("product_id") @db.Uuid
  isLifetime      Boolean        @default(false) @map("is_lifetime")
  currency        String         @default("usd") @db.VarChar(3)
  unitAmountCents BigInt         @map("unit_amount_cents")
  orderId         String?        @map("order_id") @db.Uuid
  subscriptionId  String?        @map("subscription_id") @db.Uuid
  status          PurchaseStatus @default(ACTIVE)
  revokedAt       DateTime?      @map("revoked_at") @db.Timestamptz(6)
  revokeReason    String?        @map("revoke_reason") @db.Text
  expiresAt       DateTime?      @map("expires_at") @db.Timestamptz(6)
  metadata        Json?          @default("{}")
  isLiveMode      Boolean        @default(true) @map("is_live_mode")
  grantedAt       DateTime       @default(now()) @map("granted_at") @db.Timestamptz(6)
  createdAt       DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime       @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations (order_id is NOT a FK â€” cannot reference partitioned table)
  customer             Customer             @relation(fields: [customerId], references: [id], onUpdate: NoAction)
  product              Product              @relation(fields: [productId], references: [id], onUpdate: NoAction)
  subscription         Subscription?        @relation(fields: [subscriptionId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  masterClassAttendees MasterClassAttendee[]

  @@index([customerId], map: "idx_purchases_customer")
  @@index([productId], map: "idx_purchases_product")
  @@map("purchases")
}

// ===================== Master Classes =====================

model MasterClassSession {
  id                  String    @id @default(dbgenerated("uuidv7()")) @db.Uuid
  productId           String    @map("product_id") @db.Uuid
  sessionNumber       Int       @default(1) @map("session_number")
  sessionTitle        String?   @map("session_title") @db.VarChar(255)
  scheduledAt         DateTime  @map("scheduled_at") @db.Timestamptz(6)
  durationMinutes     Int       @default(60) @map("duration_minutes")
  timezone            String?   @default("UTC") @db.VarChar(50)
  platform            String    @db.VarChar(50)
  liveUrl             String?   @map("live_url") @db.VarChar(500)
  recordingStatus     String?   @default("pending") @map("recording_status") @db.VarChar(20)
  recordingUrl        String?   @map("recording_url") @db.VarChar(500)
  recordingAvailableAt DateTime? @map("recording_available_at") @db.Timestamptz(6)
  status              String?   @default("scheduled") @db.VarChar(20)
  scheduledByStaffId  String?   @map("scheduled_by_staff_id") @db.Uuid
  updatedByStaffId    String?   @map("updated_by_staff_id") @db.Uuid
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  product        Product              @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  scheduledBy    Staff?               @relation("SessionScheduledBy", fields: [scheduledByStaffId], references: [id], onUpdate: NoAction)
  updatedBy      Staff?               @relation("SessionUpdatedBy", fields: [updatedByStaffId], references: [id], onUpdate: NoAction)
  attendees      MasterClassAttendee[]

  @@unique([productId, sessionNumber])
  @@index([productId], map: "idx_mcs_product")
  @@map("master_class_sessions")
}

model MasterClassAttendee {
  id               String             @id @default(dbgenerated("uuidv7()")) @db.Uuid
  sessionId        String             @map("session_id") @db.Uuid
  customerId       String             @map("customer_id") @db.Uuid
  purchaseId       String             @map("purchase_id") @db.Uuid
  registeredAt     DateTime           @default(now()) @map("registered_at") @db.Timestamptz(6)
  attended         Boolean            @default(false)
  joinedAt         DateTime?          @map("joined_at") @db.Timestamptz(6)
  recordingWatched Boolean            @default(false) @map("recording_watched")
  session          MasterClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  customer         Customer           @relation(fields: [customerId], references: [id], onUpdate: NoAction)
  purchase         Purchase           @relation(fields: [purchaseId], references: [id], onUpdate: NoAction)

  @@unique([sessionId, customerId])
  @@index([customerId], map: "idx_mca_customer")
  @@map("master_class_attendees")
}

// ===================== Content: Sections, Lessons & Posts =====================

model Section {
  id          String   @id @default(dbgenerated("uuidv7()")) @db.Uuid
  productId   String   @map("product_id") @db.Uuid
  title       String   @db.VarChar(500)
  description String?  @db.Text
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  product Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lessons Lesson[]
  topics  Topic[]
  quizzes Quiz[]

  @@index([productId], map: "idx_sections_product")
  @@map("sections")
}

model Lesson {
  id          String     @id @default(dbgenerated("uuidv7()")) @db.Uuid
  productId   String     @map("product_id") @db.Uuid
  sectionId   String     @map("section_id") @db.Uuid
  title       String     @db.VarChar(500)
  content     String?    @db.Text
  videoId     String?    @map("video_id") @db.Uuid
  lessonType  LessonType @default(TEXT) @map("lesson_type")
  duration    Int?       @default(0)
  sortOrder   Int        @default(0) @map("sort_order")
  sectionName String?    @map("section_name") @db.VarChar(500)
  isPublished Boolean    @default(false) @map("is_published")
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime?  @map("deleted_at") @db.Timestamptz(6)

  product Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  section Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  video   Video?   @relation(fields: [videoId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  topics  Topic[]

  @@index([productId], map: "lessons_product_id_index")
  @@index([sectionId], map: "idx_lessons_section")
  @@index([videoId], map: "idx_lessons_video")
  @@map("lessons")
}

model Topic {
  id          String    @id @default(dbgenerated("uuidv7()")) @db.Uuid
  lessonId    String    @map("lesson_id") @db.Uuid
  productId   String    @map("product_id") @db.Uuid
  sectionId   String    @map("section_id") @db.Uuid
  title       String    @db.VarChar(500)
  content     String?   @db.Text
  videoId     String?   @map("video_id") @db.Uuid
  topicType   TopicType @default(TEXT) @map("topic_type")
  duration    Int?      @default(0)
  sortOrder   Int       @default(0) @map("sort_order")
  isPublished Boolean   @default(false) @map("is_published")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  lesson  Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  video   Video?  @relation(fields: [videoId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([lessonId], map: "idx_topics_lesson")
  @@index([productId], map: "idx_topics_product")
  @@index([sectionId], map: "idx_topics_section")
  @@index([videoId], map: "idx_topics_video")
  @@map("topics")
}

model Post {
  id             String    @id @default(dbgenerated("uuidv7()")) @db.Uuid
  title          String    @db.VarChar(500)
  slug           String    @unique @db.VarChar(500)
  content        String    @db.Text
  excerpt        String?   @db.VarChar(1000)
  coverImageUrl  String?   @map("cover_image_url") @db.VarChar(1000)
  authorId       String    @map("author_id") @db.Uuid
  isPublished    Boolean   @default(false) @map("is_published")
  publishedAt    DateTime? @map("published_at") @db.Timestamptz(6)
  seoTitle       String?   @map("seo_title") @db.VarChar(500)
  seoDescription String?   @map("seo_description") @db.VarChar(1000)
  seoKeywords    String?   @map("seo_keywords") @db.VarChar(500)
  wpPostId           Int?              @map("wp_post_id")
  subscriptionPlanId String?           @map("subscription_plan_id") @db.Uuid
  createdAt          DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt          DateTime?         @map("deleted_at") @db.Timestamptz(6)
  author             Staff             @relation(fields: [authorId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  subscriptionPlan   SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  categories         PostCategory[]
  tags               PostTag[]

  @@index([authorId], map: "posts_author_id_index")
  @@index([slug], map: "posts_slug_index")
  @@index([wpPostId], map: "posts_wp_post_id_index")
  @@index([subscriptionPlanId], map: "idx_posts_subscription_plan")
  @@map("posts")
}

model Category {
  id          String         @id @default(dbgenerated("uuidv7()")) @db.Uuid
  name        String         @db.VarChar(255)
  slug        String         @unique @db.VarChar(255)
  description String?        @db.Text
  createdAt   DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime       @default(now()) @map("updated_at") @db.Timestamptz(6)
  posts       PostCategory[]
  videos      Video[]

  @@index([slug], map: "categories_slug_index")
  @@map("categories")
}

model Tag {
  id        String    @id @default(dbgenerated("uuidv7()")) @db.Uuid
  name      String    @db.VarChar(255)
  slug      String    @unique @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)
  posts     PostTag[]

  @@index([slug], map: "tags_slug_index")
  @@map("tags")
}

model PostCategory {
  postId     String   @map("post_id") @db.Uuid
  categoryId String   @map("category_id") @db.Uuid
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([postId, categoryId])
  @@index([categoryId], map: "post_categories_category_id_index")
  @@map("post_categories")
}

model PostTag {
  postId String @map("post_id") @db.Uuid
  tagId  String @map("tag_id") @db.Uuid
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([postId, tagId])
  @@index([tagId], map: "post_tags_tag_id_index")
  @@map("post_tags")
}

// ===================== Videos =====================

model Video {
  id               String           @id @default(dbgenerated("uuidv7()")) @db.Uuid
  bunnyVideoId     String           @unique @map("bunny_video_id") @db.VarChar(100)
  title            String           @db.VarChar(500)
  description      String?          @db.Text
  thumbnailUrl     String?          @map("thumbnail_url") @db.VarChar(1000)
  duration         Int              @default(0)
  bunnyLibraryType BunnyLibraryType @default(PRIVATE) @map("bunny_library_type")
  videoStatus      VideoStatus      @default(PROCESSING) @map("video_status")
  encodeProgress   Int              @default(0) @map("encode_progress") @db.SmallInt
  instructorId     String           @map("instructor_id") @db.Uuid
  categoryId       String?          @map("category_id") @db.Uuid
  isPublished      Boolean          @default(false) @map("is_published")
  publishedAt      DateTime?        @map("published_at") @db.Timestamptz(6)
  sortOrder        Int              @default(0) @map("sort_order")
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt        DateTime?        @map("deleted_at") @db.Timestamptz(6)

  instructor Staff     @relation(fields: [instructorId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  category   Category? @relation(fields: [categoryId], references: [id], onUpdate: NoAction)
  lessons    Lesson[]
  topics     Topic[]

  @@index([instructorId], map: "idx_videos_instructor")
  @@index([isPublished], map: "idx_videos_published")
  @@map("videos")
}

// ===================== Quizzes =====================

model Quiz {
  id                String         @id @default(dbgenerated("uuidv7()")) @db.Uuid
  productId         String         @map("product_id") @db.Uuid
  sectionId         String?        @map("section_id") @db.Uuid
  title             String         @db.VarChar(500)
  description       String?        @db.Text
  passingPercentage Int            @default(80) @map("passing_percentage")
  timeLimitSeconds  Int?           @map("time_limit_seconds")
  sortOrder         Int            @default(0) @map("sort_order")
  sectionName       String?        @map("section_name") @db.Text
  isPublished       Boolean        @default(false) @map("is_published")
  wpPostId          Int?           @map("wp_post_id")
  metadata          Json?          @default("{}")
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt         DateTime?      @map("deleted_at") @db.Timestamptz(6)

  product   Product        @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  section   Section?       @relation(fields: [sectionId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  questions QuizQuestion[]

  @@index([productId], map: "idx_quizzes_product")
  @@index([sectionId], map: "idx_quizzes_section")
  @@index([wpPostId], map: "idx_quizzes_wp_post_id")
  @@map("quizzes")
}

model QuizQuestion {
  id             String       @id @default(dbgenerated("uuidv7()")) @db.Uuid
  quizId         String       @map("quiz_id") @db.Uuid
  questionText   String       @map("question_text") @db.Text
  questionType   QuestionType @default(SINGLE) @map("question_type")
  points         Int          @default(1)
  sortOrder      Int          @default(0) @map("sort_order")
  hint           String?      @db.Text
  wpPostId       Int?         @map("wp_post_id")
  questionProId  Int?         @map("question_pro_id")
  metadata       Json?        @default("{}")
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime?    @map("deleted_at") @db.Timestamptz(6)

  quiz    Quiz                 @relation(fields: [quizId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  options QuizQuestionOption[]

  @@index([quizId], map: "idx_quiz_questions_quiz")
  @@map("quiz_questions")
}

model QuizQuestionOption {
  id         String   @id @default(dbgenerated("uuidv7()")) @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  optionText String   @map("option_text") @db.Text
  isCorrect  Boolean   @default(false) @map("is_correct")
  sortOrder  Int       @default(0) @map("sort_order")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz(6)

  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([questionId], map: "idx_quiz_options_question")
  @@map("quiz_question_options")
}

// ===================== Migration tracking =====================

model pgmigrations {
  id     Int      @id @default(autoincrement())
  name   String   @db.VarChar(255)
  run_on DateTime @db.Timestamp(6)
}
